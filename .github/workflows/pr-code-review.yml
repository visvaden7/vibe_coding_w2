name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **.py
          **.js
          **.html
          **.css
    
    - name: Auto code review
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pull_number = context.issue.number;
          
          // ë³€ê²½ëœ íŒŒì¼ë“¤ì— ëŒ€í•œ ê¸°ë³¸ ë¦¬ë·° ì½”ë©˜íŠ¸
          const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');
          
          let reviewComments = [];
          
          for (const file of changedFiles) {
            if (file.endsWith('.py')) {
              reviewComments.push({
                path: file,
                body: `**Python íŒŒì¼ ë¦¬ë·° ì²´í¬í¬ì¸íŠ¸:**
                - [ ] PEP 8 ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ì¤€ìˆ˜
                - [ ] í•¨ìˆ˜/í´ë˜ìŠ¤ docstring ì‘ì„±
                - [ ] ì ì ˆí•œ ì˜ˆì™¸ ì²˜ë¦¬
                - [ ] íƒ€ì… íŒíŠ¸ ì‚¬ìš©
                - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ í¬í•¨`,
                line: 1
              });
            }
            
            if (file.startsWith('test_')) {
              reviewComments.push({
                path: file,
                body: `**í…ŒìŠ¤íŠ¸ íŒŒì¼ ë¦¬ë·° ì²´í¬í¬ì¸íŠ¸:**
                - [ ] ëª¨ë“  ì¤‘ìš” ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
                - [ ] Edge case ì²˜ë¦¬
                - [ ] Mock ì ì ˆíˆ ì‚¬ìš©
                - [ ] í…ŒìŠ¤íŠ¸ ì´ë¦„ì´ ëª…í™•í•¨
                - [ ] Given-When-Then íŒ¨í„´ ì ìš©`,
                line: 1
              });
            }
          }
          
          // ì „ì²´ PRì— ëŒ€í•œ ë¦¬ë·° ì½”ë©˜íŠ¸
          const reviewBody = `## ğŸ” ìë™ ì½”ë“œ ë¦¬ë·°

          **ì¼ë°˜ì ì¸ ì²´í¬í¬ì¸íŠ¸:**
          - [ ] ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±
          - [ ] ì„±ëŠ¥ ìµœì í™” ê³ ë ¤ì‚¬í•­
          - [ ] ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸
          - [ ] ì—ëŸ¬ í•¸ë“¤ë§ ì ì ˆì„±
          - [ ] ì½”ë“œ ì¤‘ë³µ ì œê±°

          **ë³€ê²½ëœ íŒŒì¼:** ${changedFiles.length}ê°œ
          ${changedFiles.map(f => `- \`${f}\``).join('\n')}

          ë¦¬ë·°ì–´ë¶„ë“¤ê»˜ì„œ ìœ„ ì²´í¬í¬ì¸íŠ¸ë“¤ì„ ì°¸ê³ í•˜ì—¬ ë¦¬ë·°í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ™`;

          // PR ë¦¬ë·° ìƒì„±
          await github.rest.pulls.createReview({
            owner,
            repo,
            pull_number,
            body: reviewBody,
            event: 'COMMENT'
          });